/** @license smfplayer.js 2013 - imaya / GREE Inc. [ https://github.com/gree/smfplayer.js ] The MIT License */(function() {'use strict';var q,r=this;function t(d,c){var e=d.split("."),b=r;e[0]in b||!b.execScript||b.execScript("var "+e[0]);for(var a;e.length&&(a=e.shift());)e.length||void 0===c?b=b[a]?b[a]:b[a]={}:b[a]=c}function u(d){var c=v;function e(){}e.prototype=c.prototype;d.X=c.prototype;d.prototype=new e;d.T=function(b,a,d){return c.prototype[a].apply(b,Array.prototype.slice.call(arguments,2))}};var w=void 0!==r.Uint8Array&&void 0!==r.Uint16Array&&void 0!==r.Uint32Array;function v(d,c,e){this.b=d;this.time=e}function y(d,c,e,b,a,k){this.b=d;this.time=e;this.channel=b;this.u=a;this.v=k}u(y);function z(d,c,e,b){this.b=d;this.time=e;this.data=b}u(z);function A(d,c,e,b){this.b=d;this.time=e;this.data=b}u(A);function B(d,c){c=c||{};this.input=d;this.a=c.index||0}
B.prototype.parse=function(){var d=this.input,c=this.a,e=this.r={},b=String.fromCharCode(d[c++],d[c++],d[c++],d[c++]);if("melo"!==b)throw Error("invalid MFi signature:"+b);e.W=(d[c++]<<24|d[c++]<<16|d[c++]<<8|d[c++])>>>0;e.S=(d[c++]<<16|d[c++])+c;e.U=d[c++];e.V=d[c++];e.i=d[c++];this.a=c;for(var d=this.input,c=this.a,e=this.h={},a;c<this.r.S;)switch(b=String.fromCharCode(d[c++],d[c++],d[c++],d[c++]),a=d[c++]<<8|d[c++],b){case "titl":case "copy":case "vers":case "date":case "prot":e[b]=String.fromCharCode.apply(null,
w?d.subarray(c,c+=a):d.slice(c,c+=a));break;case "sorc":e[b]=d[c++];break;case "note":e[b]=d[c++]<<8|d[c++];break;default:e[b]=w?d.subarray(c,c+=a):d.slice(c,c+=a)}this.a=c;D(this)};
function D(d){function c(){var c=b[a++]<<8|b[a++],c=a+c,d=[],e;if(1!==b[a++])throw Error("invalid EditInstrument const value:"+b[a-1]);for(;a<c;)e={},e.part=b[a++]>>4&3,e.modulator={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},e.carrier={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&
15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},e.octaveSelect=b[a++]&3,d.push(e);return d}function e(){var c=b[a++]<<8|b[a++],c=a+c;if(17!==b[a++])throw Error("invalid DeviceSpecific const value:"+b[a-1]);return{data:w?b.subarray(a,a+=c-a):b.slice(a,a+=c-a)}}var b=d.input,a=d.a,k,h,g,l=d.g=[],n,f,m;f=0;for(m=d.r.i;f<m;++f){k=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);if("trac"!==k)throw Error("invalid track signature:"+k);k=b[a++]<<24|b[a++]<<16|b[a++]<<8|b[a++];k=a+k;for(n=l[f]=[];a<
k;){g={};g.deltaTime=b[a++];h=b[a++];if(255!==h)g.type="note",g.subType="Note",g.voice=h>>6,g.key=h&63,g.length=b[a++],1===d.h.note&&(h=b[a++],g.velocity=h>>2,g.octaveShift=h&3);else switch(g.type="meta",h=b[a++],h>>4){case 11:switch(h&15){case 0:g.subType="MasterVolume";g.value=b[a++];break;case 10:g.subType="DrumScale";g.value={channel:b[a]>>3&7,drum:b[a++]&1};break;default:throw Error("unknown message type:"+h.toString(16));}break;case 12:g.subType="SetTempo";g.value={timeBase:7===(h&7)?NaN:Math.pow(2,
h&7)*(0===(h&8)?6:15),tempo:b[a++]};break;case 13:switch(h&15){case 0:g.subType="Point";g.value=b[a++];break;case 13:g.subType="Loop";g.value={id:b[a]>>6,count:b[a]>>2&15,point:b[a++]&3};break;case 14:g.subType="Nop";g.value=b[a++];break;case 15:g.subType="EndOfTrack";g.value=b[a++];break;default:throw Error("unkwnon message type:"+h.toString(16));}break;case 14:switch(h&15){case 0:g.subType="InstrumentLowPart";g.value={part:b[a]>>6,instrument:b[a++]&63};break;case 1:g.subType="InstrumentHighPart";
g.value={part:b[a]>>6,instrument:b[a++]&1};break;case 2:g.subType="Volume";g.value={part:b[a]>>6,volume:b[a++]&63};break;case 3:g.subType="Valance";g.value={part:b[a]>>6,valance:b[a++]&63};break;case 4:g.subType="PitchBend";g.value={part:b[a]>>6,value:b[a++]&63};break;case 5:g.subType="ChannelAssign";g.value={part:b[a]>>6,channel:b[a++]&63};break;case 6:g.subType="VolumeChange";g.value={part:b[a]>>6,volume:(b[a++]&63)<<26>>26};break;case 7:g.subType="PitchBendRange";g.value={part:b[a]>>6,value:b[a++]&
63};break;case 9:g.subType="MasterCoarseTuning";g.value={part:b[a]>>6,value:b[a++]&63};break;case 10:g.subType="Modulation";g.value={part:b[a]>>6,depth:b[a++]&63};break;default:throw Error("unkwnon message type:"+h.toString(16));}break;case 15:switch(h&15){case 0:g.subType="EditInstrument";g.value=c();break;case 1:g.subType="Vibrato";h=g;var p;a++;a++;if(1!==b[a++])throw Error("invalid Vibrato const value:"+b[a-1]);p={part:b[a++]>>5&3,"switch":b[a++]>>6};h.value=p;break;case 15:g.subType="DeviceSpecific";
g.value=e();break;default:throw Error("unkwnon message type:"+h.toString(16));}break;default:throw Error("unkwnon message type:"+h.toString(16));}n.push(g)}a=k}d.a=a}
function E(d){var c={timeDivision:48},e=c.tracks=[],c=c.plainTracks=[],b=d.g,a,k,h,g,l,n,f,m,p,x,s=[];for(f=0;16>f;++f)c[f]=[],s[f]=0;f=0;for(m=b.length;f<m;++f){a=b[f];g=[];l=n=p=0;for(x=a.length;p<x;++p)switch(k=a[p],l+=k.deltaTime,k.id=n,k.time=l,k.subType){case "Nop":break;case "Note":g[n++]=k;g[n]={id:n,type:"internal",subType:"NoteOff",time:l+k.length,key:k.key,voice:k.voice,velocity:k.velocity,octaveShift:k.octaveShift};n++;break;case "InstrumentHighPart":h=k;k=a[++p];if("InstrumentLowPart"!==
k.subType)throw Error("broken instrument");g[n]={id:n,type:"internal",subType:"ProgramChange",time:l,part:k.value.part,instrument:h.value.instrument<<6|k.value.instrument};n++;break;default:g[n++]=k}g.sort(function(a,b){return a.time>b.time?1:a.time<b.time?-1:a.id>b.id?1:a.id<b.id?-1:0});e[f]=[];l=p=0;for(x=g.length;p<x;++p){k=g[p];l=k.time;switch(k.subType){case "Note":h=F(k.key+45,k.octaveShift);a=4*f+k.voice;9===a&&(h-=10);c[a].push(G(l-s[a]).concat(144|a,h,2*k.velocity));break;case "NoteOff":h=
F(k.key+45,k.octaveShift);a=4*f+k.voice;9===a&&(h-=10);c[a].push(G(l-s[a]).concat(128|a,h,2*k.velocity));break;case "ProgramChange":a=4*f+k.part;c[a].push(G(l-s[a]).concat(192|a,k.instrument));break;case "SetTempo":h=288E7/(k.value.tempo*k.value.timeBase);a=0;c[a].push(G(l-s[a]).concat(255,81,3,h>>16&255,h>>8&255,h&255));break;case "Loop":h=k.value.count;h="LOOP_"+(0===k.value.point?"START":"END")+"=ID:"+k.value.id+",COUNT:"+(0===h?-1:h);a=0;c[a].push(G(l-s[a]).concat([255,6,h.length],h.split("").map(function(a){return a.charCodeAt(0)})));
break;case "MasterVolume":h=k.value;a=0;c[a].push(G(l-s[a]).concat(240,7,127,127,4,1,h,h,247));break;case "Modulation":a=4*f+k.value.part;c[a].push(G(l-s[a]).concat(176|a,1,2*k.value.depth));break;case "Volume":a=4*f+k.value.part;c[a].push(G(l-s[a]).concat(176|a,7,2*k.value.volume));break;case "Valance":a=4*f+k.value.part;c[a].push(G(l-s[a]).concat(176|a,10,2*(k.value.valance-32)+64));break;case "PitchBend":a=4*f+k.value.part;c[a].push(G(l-s[a]).concat(224|a,2*k.value.value,2*k.value.value));break;
case "PitchBendRange":a=4*f+k.value.part;c[a].push(G(l-s[a]).concat(176|a,100,0),[0,176|a,101,0],[0,176|a,6,2*k.value.value]);break;case "MasterCoarseTuning":a=4*f+k.value.part;c[a].push(G(l-s[a]).concat(176|a,100,0),[0,176|a,101,2],[0,176|a,6,2*k.value.value]);break;default:continue}s[a]=k.time}}return H(d,c)}function F(d,c){var e=[0,12,-24,-12];if(void 0!==e[c])return d+e[c];throw Error("invalid OctaveShift value:"+c);}
function H(d,c){var e,b,a=[77,84,104,100,0,0,0,6,0,1,0,16,0,48],k,h,g;if(void 0!==d.h.copy){h=d.h.copy;k=h.length;e=Array(k);for(b=0;b<k;++b)e[b]=h.charCodeAt(b);b=e;h=b.length;b=[0,255,2].concat(G(h),b);c[0].unshift(b)}k=0;for(h=c.length;k<h;++k){var l=c[k];b=[];e=0;for(g=l.length;e<g;++e)Array.prototype.push.apply(b,l[e]);g=b.length;e=[77,84,114,107,g>>24&255,g>>16&255,g>>8&255,g&255];a=a.concat(e,b)}w&&(a=new Uint8Array(a));return a}
function G(d){for(var c=[];128<=d;)c.unshift(d&127|(0===c.length?0:128)),d>>>=7;c.unshift(d|(0===c.length?0:128));return c};function I(d,c){c=c||{};this.input=d;this.a=c.index||0;this.length=c.length||d.length-this.a;this.offset=this.a;this.padding=void 0!==c.padding?c.padding:!0;this.F=void 0!==c.bigEndian?c.bigEndian:!1}
I.prototype.parse=function(){var d=this.length+this.offset;for(this.l=[];this.a<d;){var c=this.input,e=this.a,b=void 0;this.l.push({type:String.fromCharCode(c[e++],c[e++],c[e++],c[e++]),size:b=this.F?(c[e++]<<24|c[e++]<<16|c[e++]<<8|c[e++])>>>0:(c[e++]|c[e++]<<8|c[e++]<<16|c[e++]<<24)>>>0,offset:e});e+=b;this.padding&&1===(e-this.offset&1)&&e++;this.a=e}};function J(d,c){var e=d.l[c];return void 0===e?null:e};function K(d,c){c=c||{};c.padding=!1;c.bigEndian=!0;this.input=d;this.a=c.index||0;this.k=0;this.j=new I(d,c);this.g=[];this.w=[]}K.prototype.parse=function(){var d,c;this.j.parse();d=J(this.j,this.k++);c=this.input;var e=d.offset;if(!d||"MThd"!==d.type)throw Error("invalid header signature");this.G=c[e++]<<8|c[e++];this.i=c[e++]<<8|c[e++];this.R=c[e++]<<8|c[e++];d=0;for(c=this.i;d<c;++d)L(this)};
function L(d){function c(){var c=0,d;do d=b[a++],c=c<<7|d&127;while(0!==(d&128));return c}var e=J(d.j,d.k++),b=d.input,a=e.offset,k,h,g,l=-1,n=-1,f,m=0,p;if(!e||"MTrk"!==e.type)throw Error("invalid header signature");for(var e=e.offset+e.size,x=[],s=[];a<e;){k=c();m+=k;p=a;k=b[a++];h=k>>4&15;g=k&15;8>h?(h=l,g=n,k=l<<4|n,a--,p--):(l=h,n=g);var C=[,,,,,,,,"NoteOff","NoteOn","NoteAftertouch","ControlChange","ProgramChange","ChannelAftertouch","PitchBend"];switch(h){case 8:case 9:case 10:case 11:case 13:case 14:f=
new y(C[h],0,m,g,b[a++],b[a++]);break;case 12:f=new y(C[h],0,m,g,b[a++]);break;case 15:switch(g){case 0:f=c();if(247!==b[a+f-1])throw Error("invalid SysEx event");f=new z("SystemExclusive",0,m,w?b.subarray(a,(a+=f)-1):b.slice(a,(a+=f)-1));break;case 7:f=c();f=new z("SystemExclusive(F7)",0,m,w?b.subarray(a,a+=f):b.slice(a,a+=f));break;case 15:h=b[a++];f=c();switch(h){case 0:f=new A("SequenceNumber",0,m,[b[a++],b[a++]]);break;case 1:f=new A("TextEvent",0,m,[String.fromCharCode.apply(null,w?b.subarray(a,
a+=f):b.slice(a,a+=f))]);break;case 2:f=new A("CopyrightNotice",0,m,[String.fromCharCode.apply(null,w?b.subarray(a,a+=f):b.slice(a,a+=f))]);break;case 3:f=new A("SequenceTrackName",0,m,[String.fromCharCode.apply(null,w?b.subarray(a,a+=f):b.slice(a,a+=f))]);break;case 4:f=new A("InstrumentName",0,m,[String.fromCharCode.apply(null,w?b.subarray(a,a+=f):b.slice(a,a+=f))]);break;case 5:f=new A("Lyrics",0,m,[String.fromCharCode.apply(null,w?b.subarray(a,a+=f):b.slice(a,a+=f))]);break;case 6:f=new A("Marker",
0,m,[String.fromCharCode.apply(null,w?b.subarray(a,a+=f):b.slice(a,a+=f))]);break;case 7:f=new A("CuePoint",0,m,[String.fromCharCode.apply(null,w?b.subarray(a,a+=f):b.slice(a,a+=f))]);break;case 32:f=new A("MidiChannelPrefix",0,m,[b[a++]]);break;case 47:f=new A("EndOfTrack",0,m,[]);break;case 81:f=new A("SetTempo",0,m,[b[a++]<<16|b[a++]<<8|b[a++]]);break;case 84:f=new A("SmpteOffset",0,m,[b[a++],b[a++],b[a++],b[a++],b[a++]]);break;case 88:f=new A("TimeSignature",0,m,[b[a++],b[a++],b[a++],b[a++]]);
break;case 89:f=new A("KeySignature",0,m,[b[a++],b[a++]]);break;case 127:f=new A("SequencerSpecific",0,m,[w?b.subarray(a,a+=f):b.slice(a,a+=f)]);break;default:f=new A("Unknown",0,m,[h,w?b.subarray(a,a+=f):b.slice(a,a+=f)])}break;default:r.console.log("unknown message:",k.toString(16))}break;default:throw Error("invalid status");}h=a-p;p=w?b.subarray(p,p+h):b.slice(p,p+h);p[0]=k;f instanceof y&&"NoteOn"===f.b&&0===f.v&&(f.b=C[8],p=[128|f.channel,f.u,f.v],w&&(p=new Uint8Array(p)));s.push(p);x.push(f)}d.g.push(x);
d.w.push(s)};function M(){this.f=5E5;this.ready=!1;this.position=0;this.p=this.q=this.o=this.n=!1;this.D=1;this.t=16383}q=M.prototype;q.L=function(d){this.n=d};q.M=function(d){this.o=d};q.O=function(d){this.q=d};q.N=function(d){this.p=d};q.stop=function(){var d,c;this.pause=!0;this.e=Date.now();if(this.c)for(d=this.c.contentWindow,c=0;16>c;++c)d.postMessage("midi,b"+c.toString(16)+",78,0","*")};q.J=function(){return this.c};
function N(d){d.stop();O(d);d.pause=!1;d.track=null;d.e=-1;d.A=null;d.B=null;d.m=null;d.length=0;clearTimeout(d.d);d.ready?P(d):window.addEventListener("message",function(c){"link,ready"===c.data&&P(d)},!1)}function O(d){d.f=5E5;d.position=0}
q.play=function(){var d=this;if(!this.c)throw Error("WebMidiLink not found");this.ready?(this.length=this.track.length,this.track instanceof Array&&this.position>=this.length&&(this.position=0),Q(this)):window.addEventListener("message",function(c){"link,ready"===c.data&&(d.ready=!0,Q(d))},!1)};
function P(d){d=d.c.contentWindow;var c;for(c=0;16>c;++c)d.postMessage("midi,b"+c.toString(16)+",07,64","*"),d.postMessage("midi,b"+c.toString(16)+",0a,40","*"),d.postMessage("midi,e"+c.toString(16)+",00,40","*"),d.postMessage("midi,b"+c.toString(16)+",64,00","*"),d.postMessage("midi,b"+c.toString(16)+",65,00","*"),d.postMessage("midi,b"+c.toString(16)+",06,02","*"),d.postMessage("midi,b"+c.toString(16)+",26,00","*")}
q.Q=function(d,c){var e=this,b;this.c&&(document.body.removeChild(this.c),this.c=null);var a=c?document.getElementById(c):document.body;b=this.c=document.createElement("iframe");b.src=d||"http://www.g200kg.com/en/docs/gmplayer/";b.className="wml";a.appendChild(b);window.addEventListener("message",function(a){"link,ready"===a.data&&(e.ready=!0,e.C(e.t))},!1)};
q.C=function(d){var c;this.t=d;this.c&&(c=this.c.contentWindow,c.postMessage("midi,f0,7f,7f,04,01,"+[("0"+(d&127).toString(16)).substr(-2),("0"+(d>>7&127).toString(16)).substr(-2),"7f"].join(),"*"))};q.P=function(d){this.D=d};
function Q(d){function c(){var d=a[h].time,n=a.length,f,m,p=Date.now();if(e.pause)e.e=Date.now()-e.e;else{do{f=a[h].event;"SetTempo"===f.b&&(e.f=f.data[0]);"ControlChange"===f.b&&111===f.u&&(g[0]={pos:h});if("Marker"===f.b&&("A"===f.data[0]&&(g[0]={pos:h}),"B"===f.data[0]&&e.o&&g[0]&&"number"===typeof g[0].pos)){h=g[0].pos;e.d=setTimeout(c,0);e.position=h;return}if("Marker"===f.b&&(f=f.data[0].match(/^LOOP_(START|END)=ID:(\d+),COUNT:(-?\d+)$/)))if("START"===f[1])g[f[2]|0]=g[f[2]]||{pos:h,count:f[3]|
0};else if("END"===f[1]&&e.q){m=g[f[2]|0];if(0!==m.count){0<m.count&&m.count--;h=m.pos;e.d=setTimeout(c,0);e.position=h;return}g[f[2]|0]=null}k.postMessage(a[h++].webMidiLink,"*")}while(h<n&&a[h].time===d);h<n?(p=Date.now()-p,e.d=setTimeout(c,e.f/(1E3*b)*(a[h].time-d-p)*(1/e.D))):(window.postMessage("endoftrack","*"),e.n&&g[0]&&"number"===typeof g[0].pos?(h=g[0].pos,e.d=setTimeout(c,0)):e.p&&(O(e),Q(e)));e.position=h}}var e=d,b=d.A.R,a=d.track,k=d.c.contentWindow,h=d.position||0,g=[];d.pause?(d.d=
setTimeout(c,d.e),d.pause=!1,d.e=-1):d.d=setTimeout(c,d.f/1E3*b*d.track[0].time)}q.s=function(d){d=new K(d);N(this);d.parse();R(this,d)};q.K=function(d){d=new B(d);N(this);d.parse();this.s(E(d))};
function R(d,c){var e=d.track=[],b,a,k,h=d.m=[],g,l,n,f;a=c.g;b=Array(a.length);k=c.w;g=0;for(l=a.length;g<l;++g)b[g]=0;g=0;for(l=a.length;g<l;++g)for(b=a[g],n=0,f=b.length;n<f;++n)0===c.G&&"SequenceTrackName"===b[n].b&&(d.B=b[n].data[0]),"CopyrightNotice"===b[n].b&&h.push(b[n].data[0]),e.push({track:g,eventId:n,time:b[n].time,event:b[n],webMidiLink:"midi,"+Array.prototype.map.call(k[g][n],function(a){return a.toString(16)}).join(",")});e.sort(function(a,b){return a.time>b.time?1:a.time<b.time?-1:
a.track>b.track?1:a.track<b.track?-1:a.eventId>b.eventId?1:a.eventId<b.eventId?-1:0});d.A=c}q.I=function(){return this.B};q.H=function(){return this.m};t("SMF.Player",M);t("SMF.Player.prototype.play",M.prototype.play);t("SMF.Player.prototype.stop",M.prototype.stop);t("SMF.Player.prototype.loadMidiFile",M.prototype.s);t("SMF.Player.prototype.loadMldFile",M.prototype.K);t("SMF.Player.prototype.setLoop",M.prototype.N);t("SMF.Player.prototype.setCC111Loop",M.prototype.L);t("SMF.Player.prototype.setFalcomLoop",M.prototype.M);t("SMF.Player.prototype.setMFiLoop",M.prototype.O);t("SMF.Player.prototype.setWebMidiLink",M.prototype.Q);
t("SMF.Player.prototype.getWebMidiLink",M.prototype.J);t("SMF.Player.prototype.setTempoRate",M.prototype.P);t("SMF.Player.prototype.setMasterVolume",M.prototype.C);t("SMF.Player.prototype.getCopyright",M.prototype.H);t("SMF.Player.prototype.getSequenceName",M.prototype.I);}).call(this); //@ sourceMappingURL=smfplayer.min.js.map
