/** @license smfplayer.js 2013 - imaya / GREE Inc. [ https://github.com/gree/smfplayer.js ] The MIT License */(function() {var q,r=this;function t(c,d){var e=c.split("."),b=r;e[0]in b||!b.execScript||b.execScript("var "+e[0]);for(var a;e.length&&(a=e.shift());)e.length||void 0===d?b[a]?b=b[a]:b=b[a]={}:b[a]=d}function u(c){var d=w;function e(){}e.prototype=d.prototype;c.ia=d.prototype;c.prototype=new e;c.prototype.constructor=c;c.ea=function(b,a,c){for(var e=Array(arguments.length-2),g=2;g<arguments.length;g++)e[g-2]=arguments[g];return d.prototype[a].apply(b,e)}};function w(c,d,e){this.g=c;this.time=e}function x(c,d,e,b,a,f){this.g=c;this.time=e;this.b=b;this.F=a;this.a=f}u(x);function z(c,d,e,b){this.g=c;this.time=e;this.data=b}u(z);function A(c,d,e,b){this.g=c;this.time=e;this.data=b}u(A);function B(c){var d;d=d||{};this.b=c;this.a=d.index||0}
function D(c){function d(){var c=b[a++]<<8|b[a++],c=a+c,d=[],e;if(1!==b[a++])throw Error("invalid EditInstrument const value:"+b[a-1]);for(;a<c;)e={},e.part=b[a++]>>4&3,e.modulator={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},e.carrier={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&
15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},e.octaveSelect=b[a++]&3,d.push(e);return d}function e(){var c=b[a++]<<8|b[a++],c=a+c;if(17!==b[a++])throw Error("invalid DeviceSpecific const value:"+b[a-1]);return{data:b.subarray(a,a+=c-a)}}var b=c.b,a=c.a,f,h,g,m=c.l=[],n,k,l;k=0;for(l=c.f.m;k<l;++k){f=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);if("trac"!==f)throw Error("invalid track signature:"+f);f=b[a++]<<24|b[a++]<<16|b[a++]<<8|b[a++];f=a+f;for(n=m[k]=[];a<f;){g={};g.deltaTime=b[a++];
h=b[a++];if(255!==h)g.type="note",g.subType="Note",g.voice=h>>6,g.key=h&63,g.length=b[a++],1===c.c.note&&(h=b[a++],g.velocity=h>>2,g.octaveShift=h&3);else switch(g.type="meta",h=b[a++],h>>4){case 11:switch(h&15){case 0:g.subType="MasterVolume";g.value=b[a++];break;case 10:g.subType="DrumScale";g.value={channel:b[a]>>3&7,drum:b[a++]&1};break;default:throw Error("unknown message type:"+h.toString(16));}break;case 12:g.subType="SetTempo";g.value={timeBase:7===(h&7)?NaN:Math.pow(2,h&7)*(0===(h&8)?6:15),
tempo:b[a++]};break;case 13:switch(h&15){case 0:g.subType="Point";g.value=b[a++];break;case 13:g.subType="Loop";g.value={id:b[a]>>6,count:b[a]>>2&15,point:b[a++]&3};break;case 14:g.subType="Nop";g.value=b[a++];break;case 15:g.subType="EndOfTrack";g.value=b[a++];break;default:throw Error("unkwnon message type:"+h.toString(16));}break;case 14:switch(h&15){case 0:g.subType="InstrumentLowPart";g.value={part:b[a]>>6,instrument:b[a++]&63};break;case 1:g.subType="InstrumentHighPart";g.value={part:b[a]>>
6,instrument:b[a++]&1};break;case 2:g.subType="Volume";g.value={part:b[a]>>6,volume:b[a++]&63};break;case 3:g.subType="Valance";g.value={part:b[a]>>6,valance:b[a++]&63};break;case 4:g.subType="PitchBend";g.value={part:b[a]>>6,value:b[a++]&63};break;case 5:g.subType="ChannelAssign";g.value={part:b[a]>>6,channel:b[a++]&63};break;case 6:g.subType="VolumeChange";g.value={part:b[a]>>6,volume:(b[a++]&63)<<26>>26};break;case 7:g.subType="PitchBendRange";g.value={part:b[a]>>6,value:b[a++]&63};break;case 9:g.subType=
"MasterCoarseTuning";g.value={part:b[a]>>6,value:b[a++]&63};break;case 10:g.subType="Modulation";g.value={part:b[a]>>6,depth:b[a++]&63};break;default:throw Error("unkwnon message type:"+h.toString(16));}break;case 15:switch(h&15){case 0:g.subType="EditInstrument";g.value=d();break;case 1:g.subType="Vibrato";h=g;var p;a++;a++;if(1!==b[a++])throw Error("invalid Vibrato const value:"+b[a-1]);p={part:b[a++]>>5&3,"switch":b[a++]>>6};h.value=p;break;case 15:g.subType="DeviceSpecific";g.value=e();break;
default:throw Error("unkwnon message type:"+h.toString(16));}break;default:throw Error("unkwnon message type:"+h.toString(16));}n.push(g)}a=f}c.a=a}
function E(c){var d={timeDivision:48},e=d.tracks=[],d=d.plainTracks=[],b=c.l,a,f,h,g,m,n,k,l,p,y,v=[];for(k=0;16>k;++k)d[k]=[],v[k]=0;k=0;for(l=b.length;k<l;++k){a=b[k];g=[];m=n=p=0;for(y=a.length;p<y;++p)switch(f=a[p],m+=f.deltaTime,f.id=n,f.time=m,f.subType){case "Nop":break;case "Note":g[n++]=f;g[n]={id:n,type:"internal",subType:"NoteOff",time:m+f.length,key:f.key,voice:f.voice,velocity:f.velocity,octaveShift:f.octaveShift};n++;break;case "InstrumentHighPart":h=f;f=a[++p];if("InstrumentLowPart"!==
f.subType)throw Error("broken instrument");g[n]={id:n,type:"internal",subType:"ProgramChange",time:m,part:f.value.part,instrument:h.value.instrument<<6|f.value.instrument};n++;break;default:g[n++]=f}g.sort(function(a,b){return a.time>b.time?1:a.time<b.time?-1:a.id>b.id?1:a.id<b.id?-1:0});e[k]=[];m=p=0;for(y=g.length;p<y;++p){f=g[p];m=f.time;switch(f.subType){case "Note":h=F(f.key+45,f.octaveShift);a=4*k+f.voice;9===a&&(h-=10);d[a].push(G(m-v[a]).concat(144|a,h,2*f.velocity));break;case "NoteOff":h=
F(f.key+45,f.octaveShift);a=4*k+f.voice;9===a&&(h-=10);d[a].push(G(m-v[a]).concat(128|a,h,2*f.velocity));break;case "ProgramChange":a=4*k+f.part;d[a].push(G(m-v[a]).concat(192|a,f.instrument));break;case "SetTempo":h=288E7/(f.value.tempo*f.value.timeBase);a=0;d[a].push(G(m-v[a]).concat(255,81,3,h>>16&255,h>>8&255,h&255));break;case "Loop":h=f.value.count;h="LOOP_"+(0===f.value.point?"START":"END")+"=ID:"+f.value.id+",COUNT:"+(0===h?-1:h);a=0;d[a].push(G(m-v[a]).concat([255,6,h.length],h.split("").map(function(a){return a.charCodeAt(0)})));
break;case "MasterVolume":h=f.value;a=0;d[a].push(G(m-v[a]).concat(240,7,127,127,4,1,h,h,247));break;case "Modulation":a=4*k+f.value.part;d[a].push(G(m-v[a]).concat(176|a,1,2*f.value.depth));break;case "Volume":a=4*k+f.value.part;d[a].push(G(m-v[a]).concat(176|a,7,2*f.value.volume));break;case "Valance":a=4*k+f.value.part;d[a].push(G(m-v[a]).concat(176|a,10,2*(f.value.valance-32)+64));break;case "PitchBend":a=4*k+f.value.part;d[a].push(G(m-v[a]).concat(224|a,2*f.value.value,2*f.value.value));break;
case "PitchBendRange":a=4*k+f.value.part;d[a].push(G(m-v[a]).concat(176|a,100,0),[0,176|a,101,0],[0,176|a,6,2*f.value.value]);break;case "MasterCoarseTuning":a=4*k+f.value.part;d[a].push(G(m-v[a]).concat(176|a,100,0),[0,176|a,101,2],[0,176|a,6,2*f.value.value]);break;default:continue}v[a]=f.time}}return H(c,d)}function F(c,d){var e=[0,12,-24,-12];if(void 0!==e[d])return c+e[d];throw Error("invalid OctaveShift value:"+d);}
function H(c,d){var e,b,a=[77,84,104,100,0,0,0,6,0,1,0,16,0,48],f,h,g;if(void 0!==c.c.copy){h=c.c.copy;f=h.length;e=Array(f);for(b=0;b<f;++b)e[b]=h.charCodeAt(b);b=e;h=b.length;b=[0,255,2].concat(G(h),b);d[0].unshift(b)}f=0;for(h=d.length;f<h;++f){var m=d[f];b=[];e=0;for(g=m.length;e<g;++e)Array.prototype.push.apply(b,m[e]);g=b.length;e=[77,84,114,107,g>>24&255,g>>16&255,g>>8&255,g&255];a=a.concat(e,b)}return new Uint8Array(a)}
function G(c){for(var d=[];128<=c;)d.unshift(c&127|(0===d.length?0:128)),c>>>=7;d.unshift(c|(0===d.length?0:128));return d};function I(c,d){d=d||{};this.f=c;this.a=d.index||0;this.length=d.length||c.length-this.a;this.b=this.a;this.h=void 0!==d.padding?d.padding:!0;this.i=void 0!==d.bigEndian?d.bigEndian:!1}function J(c,d){var e=c.c[d];return void 0===e?null:e};function K(c){var d;d=d||{};d.padding=!1;d.bigEndian=!0;this.b=c;this.c=0;this.a=new I(c,d);this.l=[];this.G=[]}
function L(c){function d(){var c=0,d;do d=b[a++],c=c<<7|d&127;while(0!==(d&128));return c}var e=J(c.a,c.c++),b=c.b,a=e.offset,f,h,g,m=-1,n=-1,k,l=0,p;if(!e||"MTrk"!==e.type)throw Error("invalid header signature");for(var e=e.offset+e.size,y=[],v=[];a<e;){f=d();l+=f;p=a;f=b[a++];h=f>>4&15;g=f&15;8>h?(h=m,g=n,f=m<<4|n,a--,p--):(m=h,n=g);var C=[,,,,,,,,"NoteOff","NoteOn","NoteAftertouch","ControlChange","ProgramChange","ChannelAftertouch","PitchBend"];switch(h){case 8:case 9:case 10:case 11:case 13:case 14:k=
new x(C[h],0,l,g,b[a++],b[a++]);break;case 12:k=new x(C[h],0,l,g,b[a++]);break;case 15:switch(g){case 0:k=d();if(247!==b[a+k-1])throw Error("invalid SysEx event");k=new z("SystemExclusive",0,l,b.subarray(a,(a+=k)-1));break;case 7:k=d();k=new z("SystemExclusive(F7)",0,l,b.subarray(a,a+=k));break;case 15:h=b[a++];k=d();switch(h){case 0:k=new A("SequenceNumber",0,l,[b[a++],b[a++]]);break;case 1:k=new A("TextEvent",0,l,[String.fromCharCode.apply(null,b.subarray(a,a+=k))]);break;case 2:k=new A("CopyrightNotice",
0,l,[String.fromCharCode.apply(null,b.subarray(a,a+=k))]);break;case 3:k=new A("SequenceTrackName",0,l,[String.fromCharCode.apply(null,b.subarray(a,a+=k))]);break;case 4:k=new A("InstrumentName",0,l,[String.fromCharCode.apply(null,b.subarray(a,a+=k))]);break;case 5:k=new A("Lyrics",0,l,[String.fromCharCode.apply(null,b.subarray(a,a+=k))]);break;case 6:k=new A("Marker",0,l,[String.fromCharCode.apply(null,b.subarray(a,a+=k))]);break;case 7:k=new A("CuePoint",0,l,[String.fromCharCode.apply(null,b.subarray(a,
a+=k))]);break;case 32:k=new A("MidiChannelPrefix",0,l,[b[a++]]);break;case 47:k=new A("EndOfTrack",0,l,[]);break;case 81:k=new A("SetTempo",0,l,[b[a++]<<16|b[a++]<<8|b[a++]]);break;case 84:k=new A("SmpteOffset",0,l,[b[a++],b[a++],b[a++],b[a++],b[a++]]);break;case 88:k=new A("TimeSignature",0,l,[b[a++],b[a++],b[a++],b[a++]]);break;case 89:k=new A("KeySignature",0,l,[b[a++],b[a++]]);break;case 127:k=new A("SequencerSpecific",0,l,[b.subarray(a,a+=k)]);break;default:k=new A("Unknown",0,l,[h,b.subarray(a,
a+=k)])}break;default:r.console.log("unknown message:",f.toString(16))}break;default:throw Error("invalid status");}h=a-p;p=b.subarray(p,p+h);p[0]=f;k instanceof x&&"NoteOn"===k.g&&0===k.a&&(k.g=C[8],p=new Uint8Array([128|k.b,k.F,k.a]));v.push(p);y.push(k)}c.l.push(y);c.G.push(v)};function M(){this.j=5E5;this.pause=!0;this.i=!1;this.b=0;this.D=this.H=this.C=this.B=!1;this.o=1;this.I=16383}q=M.prototype;q.V=function(c){this.B=c};q.W=function(c){this.C=c};q.Y=function(c){this.H=c};q.X=function(c){this.D=c};q.w=function(){var c;this.pause=!0;this.h=Date.now();if(this.a)for(c=0;16>c;++c)this.a.contentWindow.postMessage("midi,b"+c.toString(16)+",78,0","*")};q.R=function(){return this.a};
function N(c){c.w();O(c);c.pause=!0;c.f=null;c.h=-1;c.J=null;c.K=null;c.A=null;c.length=0;c.b=0;r.window.clearTimeout(c.c);c.i?P(c):r.window.addEventListener("message",function(d){"link,ready"===d.data&&P(c)},!1)}function O(c){c.j=5E5;c.b=0;P(c);c.pause=!1}
q.T=function(){var c=this;if(!this.a)throw Error("WebMidiLink not found");this.i?this.f?(this.length=this.f.length,this.f instanceof Array&&this.b>=this.length&&(this.b=0),Q(this)):r.console.warn("Midi file is not loaded."):r.window.addEventListener("message",function(d){"link,ready"===d.data&&(c.i=!0,Q(c))},!1)};
function P(c){var d=c.a.contentWindow,e;for(e=0;16>e;++e)d.postMessage("midi,b"+e.toString(16)+",128,0","*"),d.postMessage("midi,b"+e.toString(16)+",07,64","*"),d.postMessage("midi,b"+e.toString(16)+",0a,40","*"),d.postMessage("midi,e"+e.toString(16)+",00,40","*"),d.postMessage("midi,b"+e.toString(16)+",64,00","*"),d.postMessage("midi,b"+e.toString(16)+",65,00","*"),d.postMessage("midi,b"+e.toString(16)+",06,02","*"),d.postMessage("midi,b"+e.toString(16)+",26,00","*");c.u()}
q.aa=function(c,d){d||(d="wml");var e=this,b,a=r.window.document.getElementById(d);this.a&&(this.a=a.innerHTML=null);b=this.a=r.window.document.createElement("iframe");b.src=c||"//cdn.rawgit.com/logue/smfplayer.js/gh-pages/wml.html";b.className="wml";a.appendChild(b);r.window.addEventListener("message",function(a){"string"===typeof a.data&&(a=a.data.split(","),"link"===a[0]&&("ready"===a[1]?(e.i=!0,e.L=100,e.v(e.I)):"progress"===a[1]&&(e.L=Math.round(a[2]/a[3]*1E4))))},!1)};
q.v=function(c){this.I=c;this.a&&this.a.contentWindow.postMessage("midi,f0,7f,7f,04,01,"+[("0"+(c&127).toString(16)).substr(-2),("0"+(c>>7&127).toString(16)).substr(-2),"7f"].join(),"*")};q.$=function(c){this.o=c};
function Q(c){function d(){var c=a[h].time,k=a.length,l,p,y=Date.now();if(e.pause)e.h=Date.now()-e.h;else{do{l=a[h].event;"SetTempo"===l.g&&(e.j=l.data[0]);"ControlChange"===l.g&&111===l.F&&(g[0]={pos:h});if("Marker"===l.g&&("A"===l.data[0]&&(g[0]={pos:h}),"B"===l.data[0]&&e.C&&g[0]&&"number"===typeof g[0].pos)){h=g[0].pos;e.c=m.setTimeout(d,0);e.b=h;return}if("Marker"===l.g&&(l=l.data[0].match(/^LOOP_(START|END)=ID:(\d+),COUNT:(-?\d+)$/)))if("START"===l[1])g[l[2]|0]=g[l[2]]||{pos:h,count:l[3]|0};
else if("END"===l[1]&&e.H){p=g[l[2]|0];if(0!==p.count){0<p.count&&p.count--;h=p.pos;e.c=m.setTimeout(d,0);e.b=h;return}g[l[2]|0]=null}f.postMessage(a[h++].webMidiLink,"*")}while(h<k&&a[h].time===c);h<k?(y=Date.now()-y,e.c=m.setTimeout(d,e.j/(1E3*b)*(a[h].time-c-y)*(1/e.o))):(r.window.postMessage("endoftrack","*"),this.pause=!0,e.B&&g[0]&&"number"===typeof g[0].pos?(h=g[0].pos,e.c=m.setTimeout(d,0)):e.D&&(O(e),Q(e)));e.b=h}}var e=c,b=c.J.ca,a=c.f,f=c.a.contentWindow,h=c.b||0,g=[],m=r.window;c.pause?
(c.c=m.setTimeout(d,c.h),c.pause=!1,c.h=-1):c.c=m.setTimeout(d,c.j/1E3*b*c.f[0].time)}
q.s=function(c){c=new K(c);N(this);var d,e;d=c.a;e=d.length+d.b;for(d.c=[];d.a<e;){var b=d,a=b.f,f=b.a;b.c.push({type:String.fromCharCode(a[f++],a[f++],a[f++],a[f++]),size:a=b.i?(a[f++]<<24|a[f++]<<16|a[f++]<<8|a[f++])>>>0:(a[f++]|a[f++]<<8|a[f++]<<16|a[f++]<<24)>>>0,offset:f});f+=a;b.h&&1===(f-b.b&1)&&f++;b.a=f}d=J(c.a,c.c++);e=c.b;b=d.offset;if(!d||"MThd"!==d.type)throw Error("invalid header signature");c.ba=e[b++]<<8|e[b++];c.m=e[b++]<<8|e[b++];c.ca=e[b++]<<8|e[b++];d=0;for(e=c.m;d<e;++d)L(c);
R(this,c)};
q.S=function(c){c=new B(c);N(this);var d=c.b,e=c.a,b=c.f={},a=String.fromCharCode(d[e++],d[e++],d[e++],d[e++]);if("melo"!==a)throw Error("invalid MFi signature:"+a);b.ha=(d[e++]<<24|d[e++]<<16|d[e++]<<8|d[e++])>>>0;b.da=(d[e++]<<16|d[e++])+e;b.fa=d[e++];b.ga=d[e++];b.m=d[e++];c.a=e;for(var d=c.b,e=c.a,b=c.c={},f;e<c.f.da;)switch(a=String.fromCharCode(d[e++],d[e++],d[e++],d[e++]),f=d[e++]<<8|d[e++],a){case "titl":case "copy":case "vers":case "date":case "prot":b[a]=String.fromCharCode.apply(null,d.subarray(e,
e+=f));break;case "sorc":b[a]=d[e++];break;case "note":b[a]=d[e++]<<8|d[e++];break;default:b[a]=d.subarray(e,e+=f)}c.a=e;D(c);this.s(E(c))};
function R(c,d){var e=c.f=[],b,a,f,h=c.A=[],g,m,n,k;a=d.l;b=Array(a.length);f=d.G;g=0;for(m=a.length;g<m;++g)b[g]=0;g=0;for(m=a.length;g<m;++g)for(b=a[g],n=0,k=b.length;n<k;++n)0===d.ba&&"SequenceTrackName"===b[n].g&&(c.K=b[n].data[0]),"CopyrightNotice"===b[n].g&&h.push(b[n].data[0]),e.push({track:g,eventId:n,time:b[n].time,event:b[n],webMidiLink:"midi,"+Array.prototype.map.call(f[g][n],function(a){return a.toString(16)}).join(",")});e.sort(function(a,b){return a.time>b.time?1:a.time<b.time?-1:a.track>
b.track?1:a.track<b.track?-1:a.eventId>b.eventId?1:a.eventId<b.eventId?-1:0});c.J=d}q.P=function(){return this.K};q.M=function(){return this.A};q.O=function(){return this.b};q.Z=function(c){this.b=c};q.N=function(){return this.length};q.u=function(){this.a&&this.a.contentWindow.postMessage("midi,F0,7E,7F,09,01,F7","*")};q.U=function(){this.a&&this.a.contentWindow.postMessage("midi,b0,78,0","*")};t("SMF.Player",M);t("SMF.Player.prototype.play",M.prototype.T);t("SMF.Player.prototype.stop",M.prototype.w);t("SMF.Player.prototype.loadMidiFile",M.prototype.s);t("SMF.Player.prototype.loadMldFile",M.prototype.S);t("SMF.Player.prototype.setLoop",M.prototype.X);t("SMF.Player.prototype.setCC111Loop",M.prototype.V);t("SMF.Player.prototype.setFalcomLoop",M.prototype.W);t("SMF.Player.prototype.setMFiLoop",M.prototype.Y);t("SMF.Player.prototype.setWebMidiLink",M.prototype.aa);
t("SMF.Player.prototype.getWebMidiLink",M.prototype.R);t("SMF.Player.prototype.setTempoRate",M.prototype.$);t("SMF.Player.prototype.setMasterVolume",M.prototype.v);t("SMF.Player.prototype.getCopyright",M.prototype.M);t("SMF.Player.prototype.getSequenceName",M.prototype.P);t("SMF.Player.prototype.getLength",M.prototype.N);t("SMF.Player.prototype.setPosition",M.prototype.Z);t("SMF.Player.prototype.getPosition",M.prototype.O);t("SMF.Player.prototype.sendGmReset",M.prototype.u);
t("SMF.Player.prototype.sendAllSoundOff",M.prototype.U);}).call(this); //# sourceMappingURL=smf.player.min.js.map
